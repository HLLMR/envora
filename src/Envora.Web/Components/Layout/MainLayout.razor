@inherits LayoutComponentBase
@inject NavigationManager Navigation

<div class="envora-shell">
    <aside class="envora-sidebar">
        <div class="px-3 py-4 border-bottom border-white border-opacity-10">
            <div class="fw-semibold fs-5">Envora</div>
            <div class="text-white-50 small">vNext</div>
        </div>

        <nav class="p-2 flex-grow-1">
            <div class="envora-discipline-group">
                <div class="envora-discipline-header">General</div>
                <ul class="nav nav-pills flex-column">
                    <li class="nav-item">
                        <NavLink class="nav-link" href="/" Match="NavLinkMatch.All">
                            <span>📊</span> Dashboard
                        </NavLink>
                    </li>
                    <li class="nav-item">
                        <NavLink class="nav-link" href="/projects">
                            <span>📁</span> All Projects
                        </NavLink>
                    </li>
                </ul>
            </div>

            @if (currentProjectId.HasValue)
            {
                <div class="envora-discipline-group">
                    <div class="envora-discipline-header">Project Disciplines</div>
                    <ul class="nav nav-pills flex-column">
                        <li class="nav-item">
                            <NavLink class="nav-link" href="@($"/projects/{currentProjectId}/overview")">
                                <span>📋</span> Overview
                            </NavLink>
                        </li>
                        <li class="nav-item">
                            <NavLink class="nav-link" href="@($"/projects/{currentProjectId}/financial")">
                                <span>💰</span> Financial
                            </NavLink>
                        </li>
                        <li class="nav-item">
                            <NavLink class="nav-link" href="@($"/projects/{currentProjectId}/schedule")">
                                <span>📅</span> Schedule
                            </NavLink>
                        </li>
                        <li class="nav-item">
                            <NavLink class="nav-link" href="@($"/projects/{currentProjectId}/design/equipment")">
                                <span>🎨</span> Design
                            </NavLink>
                        </li>
                        <li class="nav-item">
                            <NavLink class="nav-link" href="@($"/projects/{currentProjectId}/service")">
                                <span>🔧</span> Service
                            </NavLink>
                        </li>
                    </ul>
                </div>
            }
        </nav>

        <div class="p-3 border-top border-white border-opacity-10 small text-white-50">
            Private / Proprietary
        </div>
    </aside>

    <main class="envora-main">
        <header class="envora-header">
            <div class="container-fluid py-3 d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-3">
                    <div class="fw-semibold fs-5" style="color: var(--envora-primary);">Envora</div>
                    @if (currentProjectId.HasValue)
                    {
                        <ProjectSwitcher CurrentProjectId="currentProjectId" />
                    }
                </div>
                <div class="d-flex align-items-center gap-2">
                    @if (apiHealth.IsHealthy)
                    {
                        <span class="badge text-bg-success">API Connected</span>
                    }
                    else
                    {
                        <span class="badge text-bg-danger">API Disconnected</span>
                    }
                </div>
            </div>
        </header>

        <section class="envora-content">
            <div class="container-fluid py-4">
                @Body
            </div>
        </section>

        @if (showNotesPanel && currentProjectId.HasValue)
        {
            <footer class="envora-notes">
                <NotesPanelComponent ProjectId="currentProjectId.Value" Context="@notesContext" />
            </footer>
        }
    </main>
</div>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">🗙</a>
</div>

@code {
    [Inject] private IApiHealthService ApiHealth { get; set; } = null!;
    [CascadingParameter] public Guid? CurrentProjectId { get; set; }
    [CascadingParameter] public string? NotesContext { get; set; }
    [CascadingParameter] public bool ShowNotesPanel { get; set; } = true;

    private IApiHealthService apiHealth => ApiHealth;
    
    // Default values when not provided via cascading parameter
    private Guid? currentProjectId => CurrentProjectId ?? GetProjectIdFromUrl();
    private string? notesContext => NotesContext;
    private bool showNotesPanel => ShowNotesPanel;
    
    private Guid? GetProjectIdFromUrl()
    {
        try
        {
            var uri = new Uri(Navigation.Uri);
            var segments = uri.AbsolutePath.Split('/', StringSplitOptions.RemoveEmptyEntries);
            if (segments.Length >= 2 && segments[0] == "projects" && Guid.TryParse(segments[1], out var projectId))
            {
                return projectId;
            }
        }
        catch
        {
            // Ignore parsing errors
        }
        return null;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ApiHealth.CheckHealthAsync();
            StateHasChanged();
            
            // Check health periodically
            _ = Task.Run(async () =>
            {
                while (true)
                {
                    await Task.Delay(TimeSpan.FromSeconds(30));
                    await ApiHealth.CheckHealthAsync();
                    await InvokeAsync(StateHasChanged);
                }
            });
        }
    }
}
